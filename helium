#!/bin/sh
# =============================================================================
# HELIUM - Universal DNS-based Ad Blocker
# Version: 4.0.0 (Universal)
# Author: Abi Darwish (Original) | Enhanced by MSS
# Supports: Debian/Ubuntu Server & OpenWrt (QWRT/NSS-based)
# =============================================================================

# -----------------------------------------------------------------------------
# CONFIGURATION
# -----------------------------------------------------------------------------
VERSION_NAME="Helium"
VERSION_NUMBER="4.1.3"
VERSION_SUFFIX="Universal"

# Paths
DNSMASQ_DIR="/etc/dnsmasq"
PROVIDERS_FILE="${DNSMASQ_DIR}/providers.txt"
ADBLOCK_HOSTS="${DNSMASQ_DIR}/adblock.hosts"
WHITELIST_FILE="${DNSMASQ_DIR}/whitelist.hosts"
BLACKLIST_FILE="${DNSMASQ_DIR}/blacklist.hosts"
DEAD_HOSTS="${DNSMASQ_DIR}/dead.hosts"
TEMP_LIST="${DNSMASQ_DIR}/list.tmp"

# Remote URLs
REMOTE_BASE="https://cdn.jsdelivr.net/gh/mss-col/helium@main"
REMOTE_PROVIDERS="${REMOTE_BASE}/providers.txt"
REMOTE_SCRIPT="${REMOTE_BASE}/helium"
REMOTE_DNSMASQ_CONF="${REMOTE_BASE}/dnsmasq.conf"
REMOTE_DEAD_HOSTS="${REMOTE_BASE}/dead.hosts"

# =============================================================================
# MODERN UI COLORS (256-color + True Color support)
# Matching Helium website design language
# =============================================================================

# Base Colors (ANSI)
GREEN="\033[1;32m"
RED="\033[1;31m"
YELLOW="\033[1;33m"
WHITE="\033[1;37m"
NOCOLOR="\033[0m"

# Extended Colors (256-color mode)
CYAN="\033[1;36m"
BLUE="\033[1;34m"
MAGENTA="\033[1;35m"
DIM="\033[2m"
BOLD="\033[1m"
ITALIC="\033[3m"

# Helium Theme Colors (256-color approximation of website palette)
# accent: #58a6ff â†’ Blue 75
# success: #3fb950 â†’ Green 78
# warning: #d29922 â†’ Yellow 178
# text-secondary: #8b949e â†’ Gray 245
HE_ACCENT="\033[38;5;75m"      # Bright blue (accent)
HE_SUCCESS="\033[38;5;78m"     # Green (success)
HE_WARNING="\033[38;5;178m"    # Orange/Yellow (warning)
HE_MUTED="\033[38;5;245m"      # Gray (muted text)
HE_BORDER="\033[38;5;240m"     # Dark gray (borders)
HE_HEADER="\033[38;5;117m"     # Light cyan (headers)
HE_HIGHLIGHT="\033[38;5;159m"  # Light blue highlight

# Background Colors for badges
BG_SUCCESS="\033[48;5;22m"     # Dark green background
BG_ERROR="\033[48;5;52m"       # Dark red background
BG_WARNING="\033[48;5;94m"     # Dark orange background
BG_INFO="\033[48;5;24m"        # Dark blue background

# Unicode Box Drawing Characters
BOX_TL="â•­"  # Top left
BOX_TR="â•®"  # Top right
BOX_BL="â•°"  # Bottom left
BOX_BR="â•¯"  # Bottom right
BOX_H="â”€"   # Horizontal
BOX_V="â”‚"   # Vertical
BOX_VR="â”œ"  # Vertical right
BOX_VL="â”¤"  # Vertical left
BOX_HD="â”¬"  # Horizontal down
BOX_HU="â”´"  # Horizontal up
BOX_CROSS="â”¼"
BOX_HEAVY_H="â”"
BOX_DOUBLE_H="â•"

# Runtime variables (set by detect_environment)
OS_TYPE=""
INSTALL_PATH=""
PUBLIC_IP=""

# -----------------------------------------------------------------------------
# UTILITY FUNCTIONS
# -----------------------------------------------------------------------------

# Print colored output
print_color() {
    color="$1"
    message="$2"
    printf "${color}%s${NOCOLOR}" "$message"
}

print_green() { print_color "$GREEN" "$1"; }
print_red() { print_color "$RED" "$1"; }
print_yellow() { print_color "$YELLOW" "$1"; }
print_white() { print_color "$WHITE" "$1"; }

# Print with newline
println_green() { print_green "$1"; printf "\n"; }
println_red() { print_red "$1"; printf "\n"; }
println_yellow() { print_yellow "$1"; printf "\n"; }
println_white() { print_white "$1"; printf "\n"; }

# Clear screen properly
clear_screen() {
    clear
    # Extra clear for OpenWrt terminals
    printf '\033[3J'
}

# =============================================================================
# MODERN UI COMPONENTS
# =============================================================================

# Print modern header with ASCII art
print_header() {
    printf "\n"
    printf " ${HE_ACCENT}â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®${NOCOLOR}\n"
    printf " ${HE_ACCENT}â”‚${NOCOLOR}                                                                 ${HE_ACCENT}â”‚${NOCOLOR}\n"
    printf " ${HE_ACCENT}â”‚${NOCOLOR}   ${HE_HEADER}â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—     â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ–ˆâ•—${NOCOLOR}            ${HE_ACCENT}â”‚${NOCOLOR}\n"
    printf " ${HE_ACCENT}â”‚${NOCOLOR}   ${HE_HEADER}â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ•‘${NOCOLOR}            ${HE_ACCENT}â”‚${NOCOLOR}\n"
    printf " ${HE_ACCENT}â”‚${NOCOLOR}   ${HE_HEADER}â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ•‘${NOCOLOR}            ${HE_ACCENT}â”‚${NOCOLOR}\n"
    printf " ${HE_ACCENT}â”‚${NOCOLOR}   ${HE_HEADER}â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘${NOCOLOR}            ${HE_ACCENT}â”‚${NOCOLOR}\n"
    printf " ${HE_ACCENT}â”‚${NOCOLOR}   ${HE_HEADER}â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘ â•šâ•â• â–ˆâ–ˆâ•‘${NOCOLOR}            ${HE_ACCENT}â”‚${NOCOLOR}\n"
    printf " ${HE_ACCENT}â”‚${NOCOLOR}   ${HE_HEADER}â•šâ•â•  â•šâ•â•â•šâ•â•â•â•â•â•â•â•šâ•â•â•â•â•â•â•â•šâ•â• â•šâ•â•â•â•â•â• â•šâ•â•     â•šâ•â•${NOCOLOR}            ${HE_ACCENT}â”‚${NOCOLOR}\n"
    printf " ${HE_ACCENT}â”‚${NOCOLOR}                                                                 ${HE_ACCENT}â”‚${NOCOLOR}\n"
    printf " ${HE_ACCENT}â”‚${NOCOLOR}   ${HE_MUTED}ðŸ›¡ï¸  Universal DNS-based Ad Blocker${NOCOLOR}                         ${HE_ACCENT}â”‚${NOCOLOR}\n"
    printf " ${HE_ACCENT}â”‚${NOCOLOR}                                                                 ${HE_ACCENT}â”‚${NOCOLOR}\n"
    printf " ${HE_ACCENT}â”‚${NOCOLOR}   ${BG_SUCCESS}${WHITE} v${VERSION_NUMBER} ${NOCOLOR}"
    if [ "$OS_TYPE" = "openwrt" ]; then
        printf " ${BG_INFO}${WHITE} OpenWrt ${NOCOLOR}"
    else
        printf " ${BG_INFO}${WHITE} Linux ${NOCOLOR}"
    fi
    printf " ${HE_MUTED}by Abi Darwish & MSS${NOCOLOR}                    ${HE_ACCENT}â”‚${NOCOLOR}\n"
    printf " ${HE_ACCENT}â”‚${NOCOLOR}                                                                 ${HE_ACCENT}â”‚${NOCOLOR}\n"
    printf " ${HE_ACCENT}â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯${NOCOLOR}\n"
}

# Print section header
print_section() {
    title="$1"
    icon="$2"
    printf "\n ${HE_BORDER}â”Œâ”€â”€${NOCOLOR} ${icon} ${HE_HEADER}${title}${NOCOLOR}\n"
}

# Print section footer
print_section_end() {
    printf " ${HE_BORDER}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NOCOLOR}\n"
}

# Print horizontal divider
print_divider() {
    printf " ${HE_BORDER}â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NOCOLOR}\n"
}

# Print info row with icon
print_info_row() {
    label="$1"
    value="$2"
    icon="$3"
    printf " ${HE_BORDER}â”‚${NOCOLOR}  ${icon} ${HE_MUTED}%-22s${NOCOLOR} ${HE_HIGHLIGHT}%s${NOCOLOR}\n" "$label" "$value"
}

# Print status badge
print_badge() {
    text="$1"
    type="$2"  # success, error, warning, info
    case "$type" in
        success) printf "${BG_SUCCESS}${WHITE} ${text} ${NOCOLOR}" ;;
        error)   printf "${BG_ERROR}${WHITE} ${text} ${NOCOLOR}" ;;
        warning) printf "${BG_WARNING}${WHITE} ${text} ${NOCOLOR}" ;;
        info)    printf "${BG_INFO}${WHITE} ${text} ${NOCOLOR}" ;;
        *)       printf "${HE_MUTED}[${text}]${NOCOLOR}" ;;
    esac
}

# Check if running as root
check_root() {
    if [ "$(id -u)" != "0" ]; then
        println_red " Error: This script must be run as root"
        exit 1
    fi
}

# Check if command exists
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# Safe file download with retry (handles OpenWrt busybox wget)
download_file() {
    url="$1"
    output="$2"
    max_retries=3
    retry=0

    while [ $retry -lt $max_retries ]; do
        if command_exists curl; then
            curl -sL -o "$output" "$url" 2>/dev/null && return 0
        elif command_exists wget; then
            # BusyBox wget needs --no-check-certificate for HTTPS
            if wget --help 2>&1 | grep -q "BusyBox"; then
                wget --no-check-certificate -q -O "$output" "$url" 2>/dev/null && return 0
            else
                wget -q -O "$output" "$url" 2>/dev/null && return 0
            fi
        fi
        retry=$((retry + 1))
        sleep 1
    done
    return 1
}

# Get public IP address
get_public_ip() {
    ip -4 addr 2>/dev/null | sed -ne 's|^.* inet \([^/]*\)/.* scope global.*$|\1|p' | awk '{print $1}' | head -1
}

# Confirm prompt (returns 0 for yes, 1 for no) - Modern style
confirm() {
    prompt="$1"
    default="${2:-n}"

    printf " ${HE_ACCENT}?${NOCOLOR} ${HE_MUTED}%s${NOCOLOR} [${HE_SUCCESS}y${NOCOLOR}/${RED}n${NOCOLOR}]: " "$prompt"
    read_input; response=$REPLY

    case "$response" in
        [yY]|[yY][eE][sS]) return 0 ;;
        [nN]|[nN][oO]) return 1 ;;
        "") [ "$default" = "y" ] && return 0 || return 1 ;;
        *) return 1 ;;
    esac
}

# Wait for user input - Modern style
press_enter() {
    printf " ${HE_MUTED}Press${NOCOLOR} ${WHITE}Enter${NOCOLOR} ${HE_MUTED}to continue...${NOCOLOR}"
    read -r _ < /dev/tty
}

# Read user input with proper terminal settings (fixes backspace on OpenWRT)
read_input() {
    # Reset terminal to sane defaults (handles backspace automatically)
    stty sane 2>/dev/null
    read -r REPLY
}

# Validate IPv4 address format
is_valid_ipv4() {
    ip="$1"
    # Check format: N.N.N.N where N is 0-255
    case "$ip" in
        *[!0-9.]*)
            return 1 ;;
    esac

    # Split and validate each octet
    IFS='.' read -r o1 o2 o3 o4 <<EOF
$ip
EOF

    # Must have exactly 4 octets
    [ -z "$o1" ] || [ -z "$o2" ] || [ -z "$o3" ] || [ -z "$o4" ] && return 1

    # Each octet must be 0-255
    for octet in $o1 $o2 $o3 $o4; do
        [ "$octet" -ge 0 ] 2>/dev/null && [ "$octet" -le 255 ] || return 1
    done

    return 0
}

# -----------------------------------------------------------------------------
# ENVIRONMENT DETECTION
# -----------------------------------------------------------------------------

detect_environment() {
    # Detect OS type
    if [ -f /etc/openwrt_release ]; then
        OS_TYPE="openwrt"
        INSTALL_PATH="/usr/sbin/helium"

        # Check for supported OpenWrt variants
        if grep -q "QWRT" /etc/openwrt_release 2>/dev/null; then
            : # QWRT supported
        elif lsmod 2>/dev/null | grep -q nss; then
            : # NSS-based supported
        else
            println_yellow " Warning: Untested OpenWrt variant"
        fi

    elif [ -f /etc/debian_version ]; then
        OS_TYPE="debian"
        INSTALL_PATH="/usr/local/sbin/helium"

    elif [ -f /etc/redhat-release ]; then
        OS_TYPE="redhat"
        INSTALL_PATH="/usr/local/sbin/helium"

    elif [ -f /etc/os-release ]; then
        # Generic Linux detection
        OS_TYPE="linux"
        INSTALL_PATH="/usr/local/sbin/helium"
    else
        println_red " Error: Unsupported operating system"
        exit 1
    fi

    # Get public IP
    PUBLIC_IP=$(get_public_ip)

    # Validate environment
    if ! command_exists dnsmasq && [ "$1" != "install" ]; then
        # dnsmasq not installed, will be handled by install function
        :
    fi
}

# Check virtualization (Linux servers only)
check_virtualization() {
    if [ "$OS_TYPE" != "openwrt" ]; then
        if command_exists systemd-detect-virt; then
            virt_type=$(systemd-detect-virt 2>/dev/null)
            case "$virt_type" in
                openvz)
                    println_red " Error: OpenVZ is not supported"
                    exit 1
                    ;;
                lxc)
                    println_yellow " Warning: LXC detected - some features may be limited"
                    ;;
            esac
        fi
    fi
}

# -----------------------------------------------------------------------------
# SERVICE MANAGEMENT (OS-specific)
# -----------------------------------------------------------------------------

# Start dnsmasq service
start_dnsmasq() {
    case "$OS_TYPE" in
        openwrt)
            /etc/init.d/dnsmasq start >/dev/null 2>&1
            /etc/init.d/dnsmasq enable >/dev/null 2>&1
            ;;
        *)
            systemctl start dnsmasq >/dev/null 2>&1
            systemctl enable dnsmasq >/dev/null 2>&1
            ;;
    esac
}

# Stop dnsmasq service
stop_dnsmasq() {
    case "$OS_TYPE" in
        openwrt)
            /etc/init.d/dnsmasq stop >/dev/null 2>&1
            ;;
        *)
            systemctl stop dnsmasq >/dev/null 2>&1
            ;;
    esac
}

# Restart dnsmasq service
restart_dnsmasq() {
    case "$OS_TYPE" in
        openwrt)
            /etc/init.d/dnsmasq restart >/dev/null 2>&1
            ;;
        *)
            systemctl restart dnsmasq >/dev/null 2>&1
            ;;
    esac
}

# Check if dnsmasq is running
is_dnsmasq_running() {
    case "$OS_TYPE" in
        openwrt)
            # Use pgrep for reliable detection across OpenWrt variants
            pgrep -x dnsmasq >/dev/null 2>&1 || \
            pidof dnsmasq >/dev/null 2>&1
            ;;
        *)
            systemctl is-active dnsmasq >/dev/null 2>&1
            ;;
    esac
}

# Get dnsmasq uptime/status info
get_dnsmasq_status() {
    if is_dnsmasq_running; then
        echo "running"
    else
        echo "stopped"
    fi
}

# -----------------------------------------------------------------------------
# PACKAGE MANAGEMENT (OS-specific)
# -----------------------------------------------------------------------------

install_packages() {
    printf " Installing required packages..."

    case "$OS_TYPE" in
        openwrt)
            # Check and install diffutils for diff command
            if ! opkg list-installed 2>/dev/null | grep -q diffutils; then
                opkg update >/dev/null 2>&1
                if ! opkg install diffutils >/dev/null 2>&1; then
                    # Fallback: try manual download for common architectures
                    println_yellow "trying fallback..."
                    arch=$(uname -m)
                    case "$arch" in
                        aarch64)
                            download_file "https://mirror-03.infra.openwrt.org/releases/packages-24.10/aarch64_cortex-a53/packages/diffutils_3.10-r1_aarch64_cortex-a53.ipk" "/tmp/diffutils.ipk"
                            opkg install /tmp/diffutils.ipk >/dev/null 2>&1
                            rm -f /tmp/diffutils.ipk
                            ;;
                    esac
                fi
            fi
            ;;
        debian|ubuntu)
            apt-get update >/dev/null 2>&1
            apt-get install -y dnsmasq dnsutils curl >/dev/null 2>&1
            # Optional packages (don't fail if unavailable)
            apt-get install -y vnstat bc >/dev/null 2>&1 || true
            ;;
        redhat|centos|fedora)
            if command_exists dnf; then
                dnf install -y dnsmasq bind-utils curl >/dev/null 2>&1
            else
                yum install -y dnsmasq bind-utils curl >/dev/null 2>&1
            fi
            ;;
        *)
            println_yellow "skipped (unknown package manager)"
            return 0
            ;;
    esac

    println_green "done"
}

# -----------------------------------------------------------------------------
# DNSMASQ CONFIGURATION (OS-specific)
# Safe config - preserves existing settings, only adds addn-hosts
# -----------------------------------------------------------------------------

# Configure dnsmasq to use adblock hosts (preserves existing config)
configure_dnsmasq_adblock() {
    case "$OS_TYPE" in
        openwrt)
            # Check if QWRT (uses dnsmasq.conf directly)
            if grep -q "QWRT" /etc/openwrt_release 2>/dev/null; then
                # Remove only helium's addn-hosts line (preserve others)
                sed -i "#addn-hosts=${ADBLOCK_HOSTS}#d" /etc/dnsmasq.conf 2>/dev/null
                # Add helium addn-hosts
                echo "addn-hosts=${ADBLOCK_HOSTS}" >> /etc/dnsmasq.conf
            else
                # Standard OpenWrt uses UCI
                uci -q delete dhcp.@dnsmasq[0].addnhosts
                uci -q add_list dhcp.@dnsmasq[0].addnhosts="${ADBLOCK_HOSTS}"
                uci commit dhcp
            fi
            ;;
        *)
            # Linux: Only modify addn-hosts line, preserve everything else
            if [ -f /etc/dnsmasq.conf ]; then
                # Remove only helium's addn-hosts entry
                sed -i "#addn-hosts=${ADBLOCK_HOSTS}#d" /etc/dnsmasq.conf
                sed -i '/addn-hosts.*adblock\.hosts/d' /etc/dnsmasq.conf
                # Add helium addn-hosts
                echo "addn-hosts=${ADBLOCK_HOSTS}" >> /etc/dnsmasq.conf
            else
                # Create minimal config with only addn-hosts
                echo "addn-hosts=${ADBLOCK_HOSTS}" > /etc/dnsmasq.conf
            fi
            ;;
    esac
}

# Remove dnsmasq adblock configuration (only removes helium's entry)
remove_dnsmasq_adblock() {
    case "$OS_TYPE" in
        openwrt)
            # Only remove helium's addn-hosts, preserve others
            sed -i "#addn-hosts=${ADBLOCK_HOSTS}#d" /etc/dnsmasq.conf 2>/dev/null
            sed -i '/addn-hosts.*adblock\.hosts/d' /etc/dnsmasq.conf 2>/dev/null
            uci -q delete dhcp.@dnsmasq[0].addnhosts
            uci commit dhcp 2>/dev/null
            ;;
        *)
            # Only remove helium's addn-hosts entry
            sed -i "#addn-hosts=${ADBLOCK_HOSTS}#d" /etc/dnsmasq.conf 2>/dev/null
            sed -i '/addn-hosts.*adblock\.hosts/d' /etc/dnsmasq.conf 2>/dev/null
            ;;
    esac
}

# Check if Helium adblock is active
is_helium_active() {
    case "$OS_TYPE" in
        openwrt)
            if grep -q "QWRT" /etc/openwrt_release 2>/dev/null; then
                grep -q "^addn-hosts=${ADBLOCK_HOSTS}" /etc/dnsmasq.conf 2>/dev/null
            else
                uci -q get dhcp.@dnsmasq[0].addnhosts 2>/dev/null | grep -q "${ADBLOCK_HOSTS}"
            fi
            ;;
        *)
            grep -q "addn-hosts=${ADBLOCK_HOSTS}" /etc/dnsmasq.conf 2>/dev/null
            ;;
    esac
}

# Get current DNS server from dnsmasq config
get_current_dns() {
    if [ -f /etc/dnsmasq.conf ]; then
        grep -E "^server=" /etc/dnsmasq.conf 2>/dev/null | head -1 | cut -d'=' -f2
    else
        echo "1.1.1.1"
    fi
}

# Set DNS server in dnsmasq config
set_dns_server() {
    new_dns="$1"
    old_dns=$(get_current_dns)

    if [ -n "$old_dns" ] && [ -f /etc/dnsmasq.conf ]; then
        sed -i "s/server=${old_dns}/server=${new_dns}/" /etc/dnsmasq.conf
    fi
}

# Check if Tailscale or other VPN DNS is active
is_vpn_dns_active() {
    # Check for Tailscale
    if pgrep -x tailscaled >/dev/null 2>&1; then
        return 0
    fi
    # Check for Tailscale DNS in resolv.conf
    if grep -q "100.100.100.100" /etc/resolv.conf 2>/dev/null; then
        return 0
    fi
    # Check for common VPN DNS patterns
    if grep -qE "tun|vpn|wg|tailscale" /etc/resolv.conf 2>/dev/null; then
        return 0
    fi
    return 1
}

# Configure resolv.conf (Linux servers only)
# Skips if Tailscale or VPN DNS detected to avoid conflicts
configure_resolv() {
    if [ "$OS_TYPE" != "openwrt" ]; then
        # Skip if VPN DNS active (Tailscale, WireGuard, etc.)
        if is_vpn_dns_active; then
            println_yellow "VPN DNS detected - skipping resolv.conf (no conflict)"
            return 0
        fi

        # Backup original if not exists
        [ ! -f /etc/resolv.conf.bak ] && cp /etc/resolv.conf /etc/resolv.conf.bak 2>/dev/null

        # Point to local dnsmasq
        echo "nameserver 127.0.0.1" > /etc/resolv.conf
    fi
}

# Restore resolv.conf (Linux servers only)
restore_resolv() {
    if [ "$OS_TYPE" != "openwrt" ]; then
        # Skip if VPN DNS active
        if is_vpn_dns_active; then
            return 0
        fi

        if [ -f /etc/resolv.conf.bak ]; then
            cp /etc/resolv.conf.bak /etc/resolv.conf
        else
            echo "nameserver 1.1.1.1" > /etc/resolv.conf
        fi
    fi
}

# -----------------------------------------------------------------------------
# CORE ENGINE
# -----------------------------------------------------------------------------

# =============================================================================
# FORMAT PARSER - Handles multiple blocklist formats
# =============================================================================
# Supported formats:
#   1. Hosts:       0.0.0.0 domain.com / 127.0.0.1 domain.com
#   2. Domain-only: domain.com
#   3. Wildcard:    *.domain.com
#   4. AdBlock:     ||domain.com^
#   5. AdBlock+opt: ||domain.com^$third-party,popup
#
# Skipped entries:
#   - Comments: ! or #
#   - Exception rules: @@||domain^
#   - Element hiding: ##.class, #@#, domain##
#   - URL patterns: /path/file.js
#   - IP addresses: 192.168.1.1
#   - Localhost entries: localhost, broadcasthost
# =============================================================================

# Process raw blocklist and extract valid domains - OPTIMIZED with awk
# Handles: hosts format, AdBlock format, wildcard, domain-only
# awk is 10-50x faster than shell while-loop for large files
process_blocklist() {
    awk '
    {
        # Trim whitespace and remove carriage return
        gsub(/\r/, "")
        gsub(/^[ \t]+|[ \t]+$/, "")
        line = $0

        # Skip empty lines and comments
        if (line == "") next
        if (line ~ /^[#!]/ || line ~ /^\[Adblock/) next

        # Skip AdBlock special rules
        if (line ~ /^@@/) next                    # Exception rules
        if (line ~ /##|#@#|#\?#/) next           # Element hiding
        if (line ~ /^\//) next                    # URL patterns
        if (line ~ /\/.*\//) next                 # Contains path
        if (line ~ /\$.*=/) next                  # Complex options
        if (line ~ /^[&\-]/) next                 # URL patterns
        if (line ~ /^\.[^.]*\//) next             # .com/path patterns

        domain = ""

        # Format 1: Hosts format (0.0.0.0 or 127.0.0.1)
        if (line ~ /^(0\.0\.0\.0|127\.0\.0\.1)[ \t]/) {
            domain = $2
        }
        # Skip IPv6 and broadcast
        else if (line ~ /^(::1|fe80:|ff0|255\.255\.255\.255)/) {
            next
        }
        # Format 2: AdBlock format (||domain^)
        else if (line ~ /^\|\|/) {
            domain = line
            gsub(/^\|\|/, "", domain)
            gsub(/\^.*/, "", domain)
            gsub(/\$.*/, "", domain)
        }
        # Format 3: Wildcard format (*.domain)
        else if (line ~ /^\*\./) {
            domain = line
            gsub(/^\*\./, "", domain)
        }
        # Format 4: Domain-only (no spaces/special chars, has dot)
        else if (line !~ /[ \t\/=&@\[\]]/ && line ~ /\./) {
            domain = line
        }

        if (domain == "") next

        # Validation
        if (domain ~ /^(localhost|local|broadcasthost|ip6-)/) next
        if (domain ~ /^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$/) next
        if (length(domain) < 4) next
        if (domain !~ /\./) next
        if (domain ~ /[*\/\\?#!$^]/) next

        print "0.0.0.0 " domain
    }'
}

# Update blocked hostnames from providers - Modern UI
update_engine() {
    printf "\n"
    print_section "Updating Blocklists" "ðŸ“¥"
    printf " ${HE_BORDER}â”‚${NOCOLOR}\n"

    # Ensure directory exists
    [ ! -d "$DNSMASQ_DIR" ] && mkdir -p "$DNSMASQ_DIR"

    # Clear temp file
    : > "$TEMP_LIST"

    # Check if providers file exists
    if [ ! -f "$PROVIDERS_FILE" ]; then
        printf " ${HE_BORDER}â”‚${NOCOLOR}  ${RED}âœ—${NOCOLOR} Error: providers.txt not found\n"
        return 1
    fi

    # Count active providers
    provider_count=0
    success_count=0
    fail_count=0

    # Process each provider
    while IFS= read -r line || [ -n "$line" ]; do
        # Skip comments and empty lines
        case "$line" in
            \#*|"") continue ;;
        esac

        # Extract URL from format: ProviderName="URL" or NAME|...|...="URL"
        list_url=$(echo "$line" | cut -d'"' -f2)
        provider_name=$(echo "$line" | cut -d'|' -f1 | cut -d'=' -f1)

        [ -z "$list_url" ] && continue

        provider_count=$((provider_count + 1))
        printf " ${HE_BORDER}â”‚${NOCOLOR}  ${HE_ACCENT}[%2d]${NOCOLOR} ${WHITE}%-25s${NOCOLOR}" "$provider_count" "$provider_name"

        # Download to temp file first for proper status check
        tmp_download="/tmp/helium_dl_$$.tmp"
        dl_status=1

        if command_exists curl; then
            curl -sL --connect-timeout 10 "$list_url" -o "$tmp_download" 2>/dev/null
            dl_status=$?
        elif command_exists wget; then
            # BusyBox wget needs --no-check-certificate for HTTPS
            if wget --help 2>&1 | grep -q "BusyBox"; then
                wget --no-check-certificate -q --timeout=10 "$list_url" -O "$tmp_download" 2>/dev/null
            else
                wget -q --timeout=10 "$list_url" -O "$tmp_download" 2>/dev/null
            fi
            dl_status=$?
        fi

        # Check download success AND file has content
        if [ $dl_status -eq 0 ] && [ -s "$tmp_download" ]; then
            cat "$tmp_download" | process_blocklist >> "$TEMP_LIST"
            printf "${HE_SUCCESS}âœ“${NOCOLOR}\n"
            success_count=$((success_count + 1))
        else
            printf "${RED}âœ—${NOCOLOR}\n"
            fail_count=$((fail_count + 1))
        fi
        rm -f "$tmp_download"

    done < "$PROVIDERS_FILE"

    # Add blacklisted hosts
    if [ -f "$BLACKLIST_FILE" ] && [ -s "$BLACKLIST_FILE" ]; then
        printf " ${HE_BORDER}â”‚${NOCOLOR}  ${HE_MUTED}Adding custom blacklist...${NOCOLOR}"
        while IFS= read -r hostname || [ -n "$hostname" ]; do
            [ -n "$hostname" ] && echo "0.0.0.0 ${hostname}" >> "$TEMP_LIST"
        done < "$BLACKLIST_FILE"
        printf "${HE_SUCCESS}âœ“${NOCOLOR}\n"
    fi

    printf " ${HE_BORDER}â”‚${NOCOLOR}\n"
    printf " ${HE_BORDER}â”‚${NOCOLOR}  ${HE_MUTED}Processing and deduplicating...${NOCOLOR}"

    # Build whitelist pattern for awk (if exists)
    whitelist_pattern=""
    if [ -f "$WHITELIST_FILE" ] && [ -s "$WHITELIST_FILE" ]; then
        whitelist_pattern=$(cat "$WHITELIST_FILE" | grep -v '^$' | tr '\n' '|' | sed 's/|$//')
    fi

    # Sort, deduplicate, clean invalid entries, and apply whitelist in single pass
    sort -u "$TEMP_LIST" 2>/dev/null | awk -v whitelist="$whitelist_pattern" '
    BEGIN { if (whitelist != "") split(whitelist, wl, "|") }
    {
        # Skip empty or invalid lines
        if ($0 == "") next
        if ($2 == "" || $2 == "0.0.0.0") next

        # Check whitelist
        skip = 0
        if (whitelist != "") {
            for (i in wl) {
                if (index($2, wl[i]) > 0) { skip = 1; break }
            }
        }
        if (!skip) print
    }' > "$ADBLOCK_HOSTS"

    # Add IPv6 entries if IPv6 is enabled (use :: not ::1)
    if ip a 2>/dev/null | grep -q "inet6"; then
        sed 's/^0\.0\.0\.0/::/' "$ADBLOCK_HOSTS" >> "$ADBLOCK_HOSTS.tmp"
        cat "$ADBLOCK_HOSTS" "$ADBLOCK_HOSTS.tmp" > "$ADBLOCK_HOSTS.merged"
        mv "$ADBLOCK_HOSTS.merged" "$ADBLOCK_HOSTS"
        rm -f "$ADBLOCK_HOSTS.tmp"
    fi

    printf "${HE_SUCCESS}âœ“${NOCOLOR}\n"

    # Whitelist already applied above, show message if it was used
    if [ -n "$whitelist_pattern" ]; then
        printf " ${HE_BORDER}â”‚${NOCOLOR}  ${HE_MUTED}Applying whitelist...${NOCOLOR}${HE_SUCCESS}âœ“${NOCOLOR}\n"
    fi

    # Cleanup
    rm -f "$TEMP_LIST"

    # Restart dnsmasq to apply changes
    printf " ${HE_BORDER}â”‚${NOCOLOR}  ${HE_MUTED}Restarting dnsmasq...${NOCOLOR}"
    restart_dnsmasq
    printf "${HE_SUCCESS}âœ“${NOCOLOR}\n"

    # Show count
    printf " ${HE_BORDER}â”‚${NOCOLOR}\n"
    if [ -f "$ADBLOCK_HOSTS" ]; then
        count=$(wc -l < "$ADBLOCK_HOSTS" | tr -d ' ')
        printf " ${HE_BORDER}â•°â”€â”€${NOCOLOR} ${HE_SUCCESS}âœ“${NOCOLOR} "
        printf "${HE_SUCCESS}%s${NOCOLOR} hostnames blocked from ${HE_ACCENT}%s${NOCOLOR} providers\n" "$count" "$provider_count"
    fi
    printf "\n"
}

# Clean dead/invalid hosts from database
clean_dead_hosts() {
    printf " Checking database..."

    # Download dead hosts list if not exists or outdated
    if [ ! -f "$DEAD_HOSTS" ]; then
        download_file "$REMOTE_DEAD_HOSTS" "$DEAD_HOSTS"
    fi

    if [ ! -f "$DEAD_HOSTS" ] || [ ! -s "$DEAD_HOSTS" ]; then
        println_yellow "skipped (no dead hosts list)"
        return 0
    fi

    old_count=$(wc -l < "$ADBLOCK_HOSTS" 2>/dev/null | tr -d ' ')
    old_count=${old_count:-0}

    sleep 1

    # Remove dead hosts (using # as sed delimiter to avoid conflicts)
    while IFS= read -r dead_host || [ -n "$dead_host" ]; do
        [ -z "$dead_host" ] && continue
        sed -i "#^0\.0\.0\.0 ${dead_host}$#d" "$ADBLOCK_HOSTS" 2>/dev/null
        sed -i "#^:: ${dead_host}$#d" "$ADBLOCK_HOSTS" 2>/dev/null
        printf "\n ${dead_host}\t"
        print_red "deleted"
    done < "$DEAD_HOSTS"

    new_count=$(wc -l < "$ADBLOCK_HOSTS" 2>/dev/null | tr -d ' ')
    new_count=${new_count:-0}

    deleted=$((old_count - new_count))

    printf "\n "
    print_green "$deleted"
    printf " dead hostnames have been deleted from the database\n"

    [ "$deleted" -gt 0 ] && restart_dnsmasq
}

# Get Helium status information - Modern UI
print_helium_status() {
    blocked_count=0
    [ -f "$ADBLOCK_HOSTS" ] && blocked_count=$(wc -l < "$ADBLOCK_HOSTS" 2>/dev/null | tr -d ' ')

    print_section "System Status" "ðŸ“Š"

    if is_dnsmasq_running && is_helium_active; then
        printf " ${HE_BORDER}â”‚${NOCOLOR}  ðŸŸ¢ ${HE_MUTED}DNSMasq              ${NOCOLOR}"
        print_badge "RUNNING" "success"
        printf "\n"

        current_dns=$(get_current_dns)
        if [ -n "$current_dns" ]; then
            printf " ${HE_BORDER}â”‚${NOCOLOR}  ðŸŒ ${HE_MUTED}DNS Server           ${NOCOLOR}${HE_ACCENT}%s${NOCOLOR}\n" "$current_dns"
        fi

        printf " ${HE_BORDER}â”‚${NOCOLOR}  ðŸš« ${HE_MUTED}Blocked Hostnames    ${NOCOLOR}${HE_SUCCESS}%s${NOCOLOR}\n" "$blocked_count"

        # Show uptime on Linux
        if [ "$OS_TYPE" != "openwrt" ]; then
            active_since=$(systemctl status dnsmasq 2>/dev/null | sed -ne 's|^.*active (running).*; \(.*\)$|\1|p')
            if [ -n "$active_since" ]; then
                printf " ${HE_BORDER}â”‚${NOCOLOR}  â±ï¸  ${HE_MUTED}Active Since         ${NOCOLOR}${HE_HIGHLIGHT}%s${NOCOLOR}\n" "$active_since"
            fi
        fi
    else
        printf " ${HE_BORDER}â”‚${NOCOLOR}  ðŸ”´ ${HE_MUTED}DNSMasq              ${NOCOLOR}"
        print_badge "STOPPED" "error"
        printf "\n"
        printf " ${HE_BORDER}â”‚${NOCOLOR}  ðŸš« ${HE_MUTED}Blocked Hostnames    ${NOCOLOR}${RED}0${NOCOLOR}\n"
    fi
    printf " ${HE_BORDER}â”‚${NOCOLOR}\n"
}

# Get machine information - Modern UI
print_machine_info() {
    print_section "Machine Info" "ðŸ’»"

    # CPU detection (supports x86, ARM32, ARM64, MIPS)
    cpu_model=$(cat /proc/cpuinfo 2>/dev/null | grep -E "^model name|^system type|^Hardware|^cpu model" | head -1 | cut -d':' -f2 | sed 's/^[ \t]*//' | cut -c1-35)
    # Fallback 1: try Model field (RPi)
    [ -z "$cpu_model" ] && cpu_model=$(grep -E "^Model" /proc/cpuinfo 2>/dev/null | head -1 | cut -d':' -f2 | sed 's/^[ \t]*//' | cut -c1-35)
    # Fallback 2: ARM64 - parse CPU part code
    if [ -z "$cpu_model" ]; then
        cpu_part=$(grep -m1 "^CPU part" /proc/cpuinfo 2>/dev/null | cut -d':' -f2 | tr -d ' ')
        case "$cpu_part" in
            0xd03) cpu_model="ARM Cortex-A53" ;;
            0xd04) cpu_model="ARM Cortex-A35" ;;
            0xd05) cpu_model="ARM Cortex-A55" ;;
            0xd07) cpu_model="ARM Cortex-A57" ;;
            0xd08) cpu_model="ARM Cortex-A72" ;;
            0xd09) cpu_model="ARM Cortex-A73" ;;
            0xd0a) cpu_model="ARM Cortex-A75" ;;
            0xd0b) cpu_model="ARM Cortex-A76" ;;
            0xd41) cpu_model="ARM Cortex-A78" ;;
            0xd44) cpu_model="ARM Cortex-X1" ;;
            *) [ -n "$cpu_part" ] && cpu_model="ARMv8 ($cpu_part)" ;;
        esac
    fi
    cpu_cores=$(grep -c "^processor" /proc/cpuinfo 2>/dev/null || echo "1")

    if [ "$cpu_cores" = "1" ]; then
        printf " ${HE_BORDER}â”‚${NOCOLOR}  ðŸ–¥ï¸  ${HE_MUTED}CPU (1 core)         ${NOCOLOR}${HE_HIGHLIGHT}%s${NOCOLOR}\n" "${cpu_model:-Unknown}"
    else
        printf " ${HE_BORDER}â”‚${NOCOLOR}  ðŸ–¥ï¸  ${HE_MUTED}CPU (${cpu_cores} cores)        ${NOCOLOR}${HE_HIGHLIGHT}%s${NOCOLOR}\n" "${cpu_model:-Unknown}"
    fi

    # OS
    if [ -f /etc/os-release ]; then
        os_name=$(grep "PRETTY_NAME" /etc/os-release 2>/dev/null | cut -d'"' -f2 | cut -c1-30)
    else
        os_name=$(uname -s)
    fi
    printf " ${HE_BORDER}â”‚${NOCOLOR}  ðŸ§ ${HE_MUTED}OS Version           ${NOCOLOR}${HE_HIGHLIGHT}%s${NOCOLOR}\n" "${os_name:-Unknown}"

    # Kernel
    kernel=$(uname -r | cut -c1-25)
    printf " ${HE_BORDER}â”‚${NOCOLOR}  âš™ï¸  ${HE_MUTED}Kernel               ${NOCOLOR}${HE_HIGHLIGHT}%s${NOCOLOR}\n" "$kernel"

    # RAM with progress bar (handle both Linux and OpenWrt/BusyBox)
    if command_exists free; then
        # Get raw values first (use Mem: exact match for BusyBox compatibility)
        ram_used=$(free 2>/dev/null | awk '/Mem:/ {print $3}')
        ram_total=$(free 2>/dev/null | awk '/Mem:/ {print $2}')

        # BusyBox free returns KB even with -m flag (it ignores it)
        # If value > 100000, it's definitely KB not MB, so convert
        if [ -n "$ram_total" ] && [ "$ram_total" -gt 100000 ]; then
            ram_used=$((ram_used / 1024))
            ram_total=$((ram_total / 1024))
        fi

        if [ -n "$ram_used" ] && [ -n "$ram_total" ] && [ "$ram_total" -gt 0 ]; then
            ram_percent=$((ram_used * 100 / ram_total))
            # Create mini progress bar
            bar_width=10
            filled=$((ram_percent * bar_width / 100))
            bar=""
            i=0; while [ $i -lt $filled ]; do bar="${bar}â–ˆ"; i=$((i+1)); done
            while [ $i -lt $bar_width ]; do bar="${bar}â–‘"; i=$((i+1)); done

            if [ "$ram_percent" -gt 80 ]; then
                ram_color="${RED}"
            elif [ "$ram_percent" -gt 60 ]; then
                ram_color="${HE_WARNING}"
            else
                ram_color="${HE_SUCCESS}"
            fi
            printf " ${HE_BORDER}â”‚${NOCOLOR}  ðŸ’¾ ${HE_MUTED}RAM                  ${NOCOLOR}${ram_color}%s${NOCOLOR} ${HE_MUTED}%s/%sMB${NOCOLOR}\n" "$bar" "$ram_used" "$ram_total"
        fi
    fi

    # Uptime
    if [ -f /proc/uptime ]; then
        uptime_seconds=$(cut -d'.' -f1 /proc/uptime)
        uptime_days=$((uptime_seconds / 86400))
        uptime_hours=$(((uptime_seconds % 86400) / 3600))
        uptime_mins=$(((uptime_seconds % 3600) / 60))

        if [ "$uptime_days" -gt 0 ]; then
            uptime_str="${uptime_days}d ${uptime_hours}h ${uptime_mins}m"
        elif [ "$uptime_hours" -gt 0 ]; then
            uptime_str="${uptime_hours}h ${uptime_mins}m"
        else
            uptime_str="${uptime_mins}m"
        fi
        printf " ${HE_BORDER}â”‚${NOCOLOR}  â° ${HE_MUTED}Uptime               ${NOCOLOR}${HE_HIGHLIGHT}%s${NOCOLOR}\n" "$uptime_str"
    fi

    # IP Address
    if [ -n "$PUBLIC_IP" ]; then
        printf " ${HE_BORDER}â”‚${NOCOLOR}  ðŸ”— ${HE_MUTED}IP Address           ${NOCOLOR}${HE_ACCENT}%s${NOCOLOR}\n" "$PUBLIC_IP"
    fi

    # Bandwidth stats (Linux with vnstat only)
    if [ "$OS_TYPE" != "openwrt" ] && command_exists vnstat; then
        daily=$(vnstat -d --oneline 2>/dev/null | awk -F';' '{print $6}' | sed 's/ //')
        monthly=$(vnstat -m --oneline 2>/dev/null | awk -F';' '{print $11}' | sed 's/ //')
        if [ -n "$daily" ]; then
            printf " ${HE_BORDER}â”‚${NOCOLOR}  ðŸ“Š ${HE_MUTED}Daily Traffic        ${NOCOLOR}${HE_HIGHLIGHT}%s${NOCOLOR}\n" "$daily"
        fi
        if [ -n "$monthly" ]; then
            printf " ${HE_BORDER}â”‚${NOCOLOR}  ðŸ“ˆ ${HE_MUTED}Monthly Traffic      ${NOCOLOR}${HE_HIGHLIGHT}%s${NOCOLOR}\n" "$monthly"
        fi
    fi
    printf " ${HE_BORDER}â”‚${NOCOLOR}\n"
}

# -----------------------------------------------------------------------------
# INSTALLATION FUNCTIONS
# -----------------------------------------------------------------------------

do_install() {
    printf " Installing Helium...\n"

    # Create directory
    [ ! -d "$DNSMASQ_DIR" ] && mkdir -p "$DNSMASQ_DIR"

    # Install packages
    install_packages

    # Handle systemd-resolved conflict (Linux only)
    if [ "$OS_TYPE" != "openwrt" ]; then
        if command_exists systemctl && systemctl is-active systemd-resolved >/dev/null 2>&1; then
            printf " Disabling systemd-resolved..."
            systemctl disable systemd-resolved >/dev/null 2>&1
            systemctl stop systemd-resolved >/dev/null 2>&1
            [ -L /etc/resolv.conf ] && unlink /etc/resolv.conf
            echo "nameserver 1.1.1.1" > /etc/resolv.conf
            println_green "done"
        fi
    fi

    # Configure dnsmasq
    configure_dnsmasq_adblock

    # Download providers list
    printf " Downloading providers list..."
    if download_file "$REMOTE_PROVIDERS" "$PROVIDERS_FILE"; then
        println_green "done"
    else
        println_yellow "using default"
        # Create minimal default providers
        cat > "$PROVIDERS_FILE" << 'EOF'
StevenBlack="https://cdn.jsdelivr.net/gh/StevenBlack/hosts@master/hosts"
HaGeZi_Pro="https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/hosts/pro.txt"
EOF
    fi

    # Note: We no longer replace dnsmasq.conf to preserve user settings
    # Only the addn-hosts line will be added by configure_dnsmasq_adblock()

    # Create empty whitelist/blacklist files
    [ ! -f "$WHITELIST_FILE" ] && touch "$WHITELIST_FILE"
    [ ! -f "$BLACKLIST_FILE" ] && touch "$BLACKLIST_FILE"

    # Setup cron job for daily updates
    printf " Setting up daily update..."
    if [ "$OS_TYPE" = "openwrt" ]; then
        # OpenWrt uses /etc/crontabs/root
        cron_file="/etc/crontabs/root"
        [ ! -f "$cron_file" ] && touch "$cron_file"
        sed -i '#helium#d' "$cron_file" 2>/dev/null
        echo "0 4 * * * ${INSTALL_PATH} --update >/dev/null 2>&1 # Helium daily update" >> "$cron_file"
        # Restart cron service
        /etc/init.d/cron restart >/dev/null 2>&1 || true
    else
        # Linux: Download daily script
        download_file "${REMOTE_BASE}/helium_daily.sh" "/usr/local/sbin/helium_daily" 2>/dev/null
        chmod 755 /usr/local/sbin/helium_daily 2>/dev/null

        # Add cron entry
        sed -i '/helium_daily/d' /etc/crontab 2>/dev/null
        echo "0 4 * * * root /usr/local/sbin/helium_daily # Helium" >> /etc/crontab 2>/dev/null
    fi
    println_green "done"

    # Update blocklist
    update_engine

    # Configure resolv.conf (Linux only)
    [ "$OS_TYPE" != "openwrt" ] && configure_resolv

    # Start dnsmasq
    start_dnsmasq

    # Copy script to install path
    script_path=$(readlink -f "$0" 2>/dev/null || echo "$0")
    if [ "$script_path" != "$INSTALL_PATH" ]; then
        cp "$script_path" "$INSTALL_PATH" 2>/dev/null
        chmod 755 "$INSTALL_PATH" 2>/dev/null
    fi

    printf "\n"
    printf " ${HE_ACCENT}â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®${NOCOLOR}\n"
    printf " ${HE_ACCENT}â”‚${NOCOLOR}  ${HE_SUCCESS}âœ“${NOCOLOR} ${WHITE}Installation completed!${NOCOLOR}                     ${HE_ACCENT}â”‚${NOCOLOR}\n"
    printf " ${HE_ACCENT}â”‚${NOCOLOR}                                                 ${HE_ACCENT}â”‚${NOCOLOR}\n"
    printf " ${HE_ACCENT}â”‚${NOCOLOR}  Type ${HE_HIGHLIGHT}helium${NOCOLOR} to start                         ${HE_ACCENT}â”‚${NOCOLOR}\n"
    printf " ${HE_ACCENT}â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯${NOCOLOR}\n"
    printf "\n"
}

do_uninstall() {
    printf " Uninstalling Helium..."

    # Stop dnsmasq
    stop_dnsmasq

    # Remove configuration
    remove_dnsmasq_adblock

    # Remove files
    rm -rf "$DNSMASQ_DIR"
    rm -f "$INSTALL_PATH"

    # Remove cron job
    if [ "$OS_TYPE" = "openwrt" ]; then
        sed -i '#helium#d' /etc/crontabs/root 2>/dev/null
        /etc/init.d/cron restart >/dev/null 2>&1 || true
    else
        sed -i '/helium/d' /etc/crontab 2>/dev/null
        rm -f /usr/local/sbin/helium_daily
    fi

    # Restore resolv.conf (Linux only)
    [ "$OS_TYPE" != "openwrt" ] && restore_resolv

    # Restart dnsmasq without adblock
    restart_dnsmasq

    println_green "done"
    echo
}

# Force uninstall - restore system to original state (no confirmation, works even if broken)
do_force_uninstall() {
    echo "==================================================="
    echo " HELIUM FORCE UNINSTALL - Restoring Original State"
    echo "==================================================="
    echo

    # Detect OS type manually (minimal detection for worst case)
    if [ -f /etc/openwrt_release ]; then
        os="openwrt"
        install_path="/usr/sbin/helium"
    else
        os="linux"
        install_path="/usr/local/sbin/helium"
    fi

    echo " [1/7] Stopping dnsmasq service..."
    if [ "$os" = "openwrt" ]; then
        /etc/init.d/dnsmasq stop 2>/dev/null || true
    else
        systemctl stop dnsmasq 2>/dev/null || true
    fi
    echo "       done"

    echo " [2/7] Removing adblock configuration..."
    # Only remove helium's addn-hosts entry, preserve other settings
    # OpenWrt
    if [ "$os" = "openwrt" ]; then
        sed -i '/addn-hosts.*adblock\.hosts/d' /etc/dnsmasq.conf 2>/dev/null || true
        sed -i '#addn-hosts=/etc/dnsmasq/adblock#d' /etc/dnsmasq.conf 2>/dev/null || true
        uci -q delete dhcp.@dnsmasq[0].addnhosts 2>/dev/null || true
        uci commit dhcp 2>/dev/null || true
    else
        # Linux - only remove helium's addn-hosts entry
        sed -i '/addn-hosts.*adblock\.hosts/d' /etc/dnsmasq.conf 2>/dev/null || true
        sed -i '#addn-hosts=/etc/dnsmasq/adblock#d' /etc/dnsmasq.conf 2>/dev/null || true
    fi
    echo "       done"

    echo " [3/7] Removing Helium files..."
    rm -rf /etc/dnsmasq 2>/dev/null || true
    rm -f "$install_path" 2>/dev/null || true
    # Also try other possible paths
    rm -f /usr/local/sbin/helium 2>/dev/null || true
    rm -f /usr/sbin/helium 2>/dev/null || true
    rm -f /usr/local/sbin/helium_daily 2>/dev/null || true
    echo "       done"

    echo " [4/7] Removing cron jobs..."
    if [ "$os" = "openwrt" ]; then
        sed -i '#helium#d' /etc/crontabs/root 2>/dev/null || true
        /etc/init.d/cron restart 2>/dev/null || true
    else
        sed -i '/helium/d' /etc/crontab 2>/dev/null || true
    fi
    echo "       done"

    echo " [5/7] Restoring DNS resolver..."
    if [ "$os" != "openwrt" ]; then
        # Check for Tailscale/VPN DNS - don't touch if active
        if pgrep -x tailscaled >/dev/null 2>&1 || grep -q "100.100.100.100" /etc/resolv.conf 2>/dev/null; then
            echo "       skipped (VPN DNS detected)"
        elif [ -f /etc/resolv.conf.bak ]; then
            cp /etc/resolv.conf.bak /etc/resolv.conf 2>/dev/null || true
            echo "       restored from backup"
        else
            echo "nameserver 1.1.1.1" > /etc/resolv.conf 2>/dev/null || true
            echo "       set to 1.1.1.1"
        fi
    else
        echo "       skipped (OpenWrt)"
    fi

    echo " [6/7] Restarting dnsmasq service..."
    if [ "$os" = "openwrt" ]; then
        /etc/init.d/dnsmasq start 2>/dev/null || true
    else
        systemctl start dnsmasq 2>/dev/null || true
    fi
    echo "       done"

    echo " [7/7] Cleanup complete"
    echo
    echo "==================================================="
    echo " Helium has been completely removed."
    echo " System restored to original state."
    echo "==================================================="
    echo
}

do_reinstall() {
    printf " Reinstalling Helium...\n"
    sleep 1

    # Preserve custom lists
    [ -f "$WHITELIST_FILE" ] && cp "$WHITELIST_FILE" /tmp/whitelist.hosts.bak
    [ -f "$BLACKLIST_FILE" ] && cp "$BLACKLIST_FILE" /tmp/blacklist.hosts.bak

    # Remove and reinstall
    remove_dnsmasq_adblock
    configure_dnsmasq_adblock

    # Download fresh providers
    download_file "$REMOTE_PROVIDERS" "$PROVIDERS_FILE"

    # Restore custom lists
    [ -f /tmp/whitelist.hosts.bak ] && mv /tmp/whitelist.hosts.bak "$WHITELIST_FILE"
    [ -f /tmp/blacklist.hosts.bak ] && mv /tmp/blacklist.hosts.bak "$BLACKLIST_FILE"

    # Update
    update_engine

    clear_screen
    print_header
    printf "\n"
    printf " ${HE_ACCENT}â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®${NOCOLOR}\n"
    printf " ${HE_ACCENT}â”‚${NOCOLOR}  ${HE_SUCCESS}âœ“${NOCOLOR} ${WHITE}Reinstallation completed!${NOCOLOR}                   ${HE_ACCENT}â”‚${NOCOLOR}\n"
    printf " ${HE_ACCENT}â”‚${NOCOLOR}                                                 ${HE_ACCENT}â”‚${NOCOLOR}\n"
    printf " ${HE_ACCENT}â”‚${NOCOLOR}  Type ${HE_HIGHLIGHT}helium${NOCOLOR} to start                         ${HE_ACCENT}â”‚${NOCOLOR}\n"
    printf " ${HE_ACCENT}â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯${NOCOLOR}\n"
    printf "\n"
}

# -----------------------------------------------------------------------------
# FEATURE: START/STOP HELIUM
# -----------------------------------------------------------------------------

do_start() {
    clear_screen
    print_header
    echo

    if is_dnsmasq_running && is_helium_active; then
        print_helium_status
        echo
        press_enter
        return
    fi

    printf " Starting Helium..."

    configure_dnsmasq_adblock
    start_dnsmasq
    [ "$OS_TYPE" != "openwrt" ] && configure_resolv

    sleep 2
    println_green "done"
    echo
    press_enter
}

do_stop() {
    clear_screen
    print_header
    echo
    print_helium_status
    echo

    if ! is_helium_active; then
        printf " Helium is not active\n"
        echo
        press_enter
        return
    fi

    if confirm "Do you want to stop Helium?"; then
        printf " Stopping Helium..."
        remove_dnsmasq_adblock
        restart_dnsmasq
        [ "$OS_TYPE" != "openwrt" ] && restore_resolv
        sleep 2
        println_green "done"
    fi
    echo
    press_enter
}

# -----------------------------------------------------------------------------
# FEATURE: UPDATE DATABASE
# -----------------------------------------------------------------------------

do_update_database() {
    clear_screen
    print_header
    echo
    print_helium_status
    echo

    if ! is_helium_active; then
        println_yellow " Helium is not active. Start Helium first."
        echo
        press_enter
        return
    fi

    if confirm "Do you want to update blocked hostnames?"; then
        update_engine
    fi
    echo
    press_enter
}

# -----------------------------------------------------------------------------
# FEATURE: PROVIDER MANAGEMENT
# -----------------------------------------------------------------------------

# Parse provider line and extract components
# Format: NAME|CATEGORY|REGION|TAGS|DESCRIPTION="URL"
# Or legacy: NAME="URL"
parse_provider_line() {
    line="$1"
    is_active=1

    # Check if commented
    case "$line" in
        \#*)
            is_active=0
            line=$(echo "$line" | sed 's/^#//')
            ;;
    esac

    # Check if new format (contains |)
    if echo "$line" | grep -q '|'; then
        P_NAME=$(echo "$line" | cut -d'|' -f1)
        P_CATEGORY=$(echo "$line" | cut -d'|' -f2)
        P_REGION=$(echo "$line" | cut -d'|' -f3)
        P_TAGS=$(echo "$line" | cut -d'|' -f4)
        P_DESC=$(echo "$line" | cut -d'|' -f5 | cut -d'=' -f1)
    else
        # Legacy format
        P_NAME=$(echo "$line" | cut -d'=' -f1)
        P_CATEGORY="Legacy"
        P_REGION="ðŸ“¦"
        P_TAGS=""
        P_DESC=""
    fi

    P_ACTIVE=$is_active
}

# Build provider index file for number-based selection
# Creates: /tmp/helium_providers.idx with format: NUMBER|NAME|ACTIVE
build_provider_index() {
    tmp_file="${PROVIDERS_FILE}.tmp"
    idx_file="/tmp/helium_providers.idx"

    : > "$idx_file"
    idx=1

    while IFS= read -r line || [ -n "$line" ]; do
        case "$line" in
            ""|"# "*|"#-"*|"#="*|"# =="*) continue ;;
        esac

        case "$line" in
            *"="*)
                parse_provider_line "$line"
                echo "${idx}|${P_NAME}|${P_ACTIVE}" >> "$idx_file"
                idx=$((idx + 1))
                ;;
        esac
    done < "$tmp_file"
}

# Get provider name by number from index
get_provider_name() {
    num="$1"
    idx_file="/tmp/helium_providers.idx"
    grep "^${num}|" "$idx_file" 2>/dev/null | cut -d'|' -f2
}

# Get provider active status by number
get_provider_status() {
    num="$1"
    idx_file="/tmp/helium_providers.idx"
    grep "^${num}|" "$idx_file" 2>/dev/null | cut -d'|' -f3
}

# Get total provider count
get_provider_count() {
    idx_file="/tmp/helium_providers.idx"
    wc -l < "$idx_file" 2>/dev/null | tr -d ' '
}

# Activate single provider by name
activate_provider_by_name() {
    name="$1"
    tmp_file="${PROVIDERS_FILE}.tmp"

    if grep -q "^#${name}|" "$tmp_file" 2>/dev/null; then
        sed -i "s/^#${name}|/${name}|/" "$tmp_file"
        return 0
    elif grep -q "^#${name}=" "$tmp_file" 2>/dev/null; then
        sed -i "s/^#${name}=/${name}=/" "$tmp_file"
        return 0
    elif grep -q "^${name}|" "$tmp_file" 2>/dev/null || grep -q "^${name}=" "$tmp_file" 2>/dev/null; then
        return 1  # Already active
    fi
    return 2  # Not found
}

# Deactivate single provider by name
deactivate_provider_by_name() {
    name="$1"
    tmp_file="${PROVIDERS_FILE}.tmp"

    if grep -q "^${name}|" "$tmp_file" 2>/dev/null; then
        sed -i "s/^${name}|/#${name}|/" "$tmp_file"
        return 0
    elif grep -q "^${name}=" "$tmp_file" 2>/dev/null; then
        sed -i "s/^${name}=/#${name}=/" "$tmp_file"
        return 0
    elif grep -q "^#${name}|" "$tmp_file" 2>/dev/null || grep -q "^#${name}=" "$tmp_file" 2>/dev/null; then
        return 1  # Already inactive
    fi
    return 2  # Not found
}

# Parse selection input and return list of numbers
# Supports: single (3), multiple (1,3,5), range (1-5), all (A)
parse_selection_input() {
    input="$1"
    max_num="$2"

    # Handle 'A' for all
    case "$input" in
        [aA])
            i=1
            while [ "$i" -le "$max_num" ]; do
                printf "%d " "$i"
                i=$((i + 1))
            done
            return 0
            ;;
    esac

    # Replace comma with space and process each part
    input_clean=$(echo "$input" | tr ',' ' ')

    for part in $input_clean; do
        # Check if range (contains -)
        case "$part" in
            *-*)
                start=$(echo "$part" | cut -d'-' -f1)
                end=$(echo "$part" | cut -d'-' -f2)
                # Validate numbers
                if [ "$start" -ge 1 ] 2>/dev/null && [ "$end" -le "$max_num" ] 2>/dev/null && [ "$start" -le "$end" ]; then
                    i=$start
                    while [ "$i" -le "$end" ]; do
                        printf "%d " "$i"
                        i=$((i + 1))
                    done
                fi
                ;;
            *)
                # Single number
                if [ "$part" -ge 1 ] 2>/dev/null && [ "$part" -le "$max_num" ] 2>/dev/null; then
                    printf "%d " "$part"
                fi
                ;;
        esac
    done
}

# Modern provider list display
show_providers_list() {
    tmp_file="${PROVIDERS_FILE}.tmp"
    [ ! -f "$tmp_file" ] && cp "$PROVIDERS_FILE" "$tmp_file"

    # Build index
    build_provider_index

    active_count=0
    inactive_count=0
    idx=1

    # First pass: count active/inactive
    while IFS= read -r line || [ -n "$line" ]; do
        case "$line" in
            \#\#*|"#"|"") continue ;;
            \#*=*|*=*)
                case "$line" in
                    \#*) inactive_count=$((inactive_count + 1)) ;;
                    *) active_count=$((active_count + 1)) ;;
                esac
                ;;
        esac
    done < "$tmp_file"

    print_section "Blocklist Providers" "ðŸ“‹"
    printf " ${HE_BORDER}â”‚${NOCOLOR}\n"
    printf " ${HE_BORDER}â”‚${NOCOLOR}  ðŸ“Š ${HE_MUTED}Summary:${NOCOLOR} "
    print_badge "${active_count} active" "success"
    printf " "
    print_badge "${inactive_count} inactive" "error"
    printf "\n"
    printf " ${HE_BORDER}â”‚${NOCOLOR}\n"
    printf " ${HE_BORDER}â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NOCOLOR}\n"
    printf " ${HE_BORDER}â”‚${NOCOLOR}  ${HE_HEADER}%-3s  %3s  %-20s %-10s %-20s${NOCOLOR}\n" "ST" "#" "NAME" "CATEGORY" "DESCRIPTION"
    printf " ${HE_BORDER}â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NOCOLOR}\n"

    # Second pass: display providers with numbers
    while IFS= read -r line || [ -n "$line" ]; do
        case "$line" in
            ""|"# "*|"#-"*|"#="*|"# =="*) continue ;;
        esac

        case "$line" in
            *"="*)
                parse_provider_line "$line"

                disp_name=$(echo "$P_NAME" | cut -c1-20)
                disp_cat=$(echo "$P_CATEGORY" | cut -c1-10)
                disp_desc=$(echo "$P_DESC" | cut -c1-20)

                if [ "$P_ACTIVE" = "1" ]; then
                    printf " ${HE_BORDER}â”‚${NOCOLOR}  ${HE_SUCCESS}ðŸŸ¢${NOCOLOR} %3d  ${WHITE}%-20s${NOCOLOR} ${HE_MUTED}%-10s${NOCOLOR} ${HE_MUTED}%-20s${NOCOLOR}\n" "$idx" "$disp_name" "$disp_cat" "$disp_desc"
                else
                    printf " ${HE_BORDER}â”‚${NOCOLOR}  ${HE_MUTED}âš«${NOCOLOR} %3d  ${DIM}%-20s${NOCOLOR} ${HE_MUTED}%-10s${NOCOLOR} ${HE_MUTED}%-20s${NOCOLOR}\n" "$idx" "$disp_name" "$disp_cat" "$disp_desc"
                fi
                idx=$((idx + 1))
                ;;
        esac
    done < "$tmp_file"

    printf " ${HE_BORDER}â”‚${NOCOLOR}\n"
    printf " ${HE_BORDER}â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NOCOLOR}\n"
}

do_activate_provider() {
    clear_screen
    print_header
    echo

    if ! is_helium_active; then
        print_helium_status
        echo
        press_enter
        return
    fi

    tmp_file="${PROVIDERS_FILE}.tmp"
    [ ! -f "$tmp_file" ] && cp "$PROVIDERS_FILE" "$tmp_file"

    show_providers_list
    max_num=$(get_provider_count)
    echo

    # Check for changes
    if [ -f "$tmp_file" ] && ! diff -q "$tmp_file" "$PROVIDERS_FILE" >/dev/null 2>&1; then
        printf " ${HE_WARNING}âš ${NOCOLOR}  ${HE_MUTED}Unsaved changes${NOCOLOR}\n"
    fi
    printf "\n ${HE_MUTED}Format:${NOCOLOR} ${WHITE}3${NOCOLOR} ${HE_MUTED}|${NOCOLOR} ${WHITE}1,3,5${NOCOLOR} ${HE_MUTED}|${NOCOLOR} ${WHITE}1-5${NOCOLOR} ${HE_MUTED}|${NOCOLOR} ${HE_SUCCESS}A${NOCOLOR}${HE_MUTED}=all${NOCOLOR}\n"
    printf " ${HE_ACCENT}â¯${NOCOLOR} ${HE_MUTED}Select to activate${NOCOLOR} (${HE_SUCCESS}s${NOCOLOR}=save ${RED}c${NOCOLOR}=cancel)${HE_MUTED}:${NOCOLOR} "
    read_input; selection=$REPLY

    case "$selection" in
        s|S)
            mv "$tmp_file" "$PROVIDERS_FILE"
            printf " Applying changes...\n"
            update_engine
            echo
            press_enter
            return
            ;;
        c|C)
            rm -f "$tmp_file"
            return
            ;;
        "")
            do_activate_provider
            return
            ;;
        *)
            # Parse selection and process each number
            numbers=$(parse_selection_input "$selection" "$max_num")
            activated=0
            skipped=0

            for num in $numbers; do
                name=$(get_provider_name "$num")
                if [ -n "$name" ]; then
                    activate_provider_by_name "$name"
                    result=$?
                    if [ $result -eq 0 ]; then
                        printf " ${GREEN}âœ“${NOCOLOR} #%d %s activated\n" "$num" "$name"
                        activated=$((activated + 1))
                    elif [ $result -eq 1 ]; then
                        skipped=$((skipped + 1))
                    fi
                fi
            done

            if [ $activated -gt 0 ] || [ $skipped -gt 0 ]; then
                printf " ${GREEN}%d activated${NOCOLOR}" "$activated"
                [ $skipped -gt 0 ] && printf ", ${YELLOW}%d already active${NOCOLOR}" "$skipped"
                printf "\n"
                sleep 1
            elif [ -z "$numbers" ]; then
                printf " ${RED}âœ—${NOCOLOR} Invalid selection\n"
                sleep 1
            fi

            # Rebuild index after changes
            build_provider_index
            do_activate_provider
            ;;
    esac
}

do_deactivate_provider() {
    clear_screen
    print_header
    echo

    if ! is_helium_active; then
        print_helium_status
        echo
        press_enter
        return
    fi

    tmp_file="${PROVIDERS_FILE}.tmp"
    [ ! -f "$tmp_file" ] && cp "$PROVIDERS_FILE" "$tmp_file"

    show_providers_list
    max_num=$(get_provider_count)
    echo

    # Check for changes
    if [ -f "$tmp_file" ] && ! diff -q "$tmp_file" "$PROVIDERS_FILE" >/dev/null 2>&1; then
        printf " ${HE_WARNING}âš ${NOCOLOR}  ${HE_MUTED}Unsaved changes${NOCOLOR}\n"
    fi
    printf "\n ${HE_MUTED}Format:${NOCOLOR} ${WHITE}3${NOCOLOR} ${HE_MUTED}|${NOCOLOR} ${WHITE}1,3,5${NOCOLOR} ${HE_MUTED}|${NOCOLOR} ${WHITE}1-5${NOCOLOR} ${HE_MUTED}|${NOCOLOR} ${RED}A${NOCOLOR}${HE_MUTED}=all${NOCOLOR}\n"
    printf " ${HE_ACCENT}â¯${NOCOLOR} ${HE_MUTED}Select to deactivate${NOCOLOR} (${HE_SUCCESS}s${NOCOLOR}=save ${RED}c${NOCOLOR}=cancel)${HE_MUTED}:${NOCOLOR} "
    read_input; selection=$REPLY

    case "$selection" in
        s|S)
            mv "$tmp_file" "$PROVIDERS_FILE"
            printf " Applying changes...\n"
            update_engine
            echo
            press_enter
            return
            ;;
        c|C)
            rm -f "$tmp_file"
            return
            ;;
        "")
            do_deactivate_provider
            return
            ;;
        *)
            # Parse selection and process each number
            numbers=$(parse_selection_input "$selection" "$max_num")
            deactivated=0
            skipped=0

            for num in $numbers; do
                name=$(get_provider_name "$num")
                if [ -n "$name" ]; then
                    deactivate_provider_by_name "$name"
                    result=$?
                    if [ $result -eq 0 ]; then
                        printf " ${RED}âœ—${NOCOLOR} #%d %s deactivated\n" "$num" "$name"
                        deactivated=$((deactivated + 1))
                    elif [ $result -eq 1 ]; then
                        skipped=$((skipped + 1))
                    fi
                fi
            done

            if [ $deactivated -gt 0 ] || [ $skipped -gt 0 ]; then
                printf " ${RED}%d deactivated${NOCOLOR}" "$deactivated"
                [ $skipped -gt 0 ] && printf ", ${YELLOW}%d already inactive${NOCOLOR}" "$skipped"
                printf "\n"
                sleep 1
            elif [ -z "$numbers" ]; then
                printf " ${RED}âœ—${NOCOLOR} Invalid selection\n"
                sleep 1
            fi

            # Rebuild index after changes
            build_provider_index
            do_deactivate_provider
            ;;
    esac
}

# -----------------------------------------------------------------------------
# FEATURE: WHITELIST MANAGEMENT
# -----------------------------------------------------------------------------

# Modern whitelist management
do_whitelist() {
    clear_screen
    print_header

    if ! is_helium_active; then
        print_helium_status
        press_enter
        return
    fi

    [ ! -f "$WHITELIST_FILE" ] && touch "$WHITELIST_FILE"
    tmp_file="${WHITELIST_FILE}.tmp"
    [ ! -f "$tmp_file" ] && cp "$WHITELIST_FILE" "$tmp_file"

    print_section "Whitelist Management" "âœ¨"
    printf " ${HE_BORDER}â”‚${NOCOLOR}\n"
    printf " ${HE_BORDER}â”‚${NOCOLOR}  ${HE_MUTED}Whitelisted domains will NOT be blocked${NOCOLOR}\n"
    printf " ${HE_BORDER}â”‚${NOCOLOR}\n"
    printf " ${HE_BORDER}â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NOCOLOR}\n"
    printf " ${HE_BORDER}â”‚${NOCOLOR}  ${HE_HEADER}%-40s %12s${NOCOLOR}\n" "DOMAIN" "STATUS"
    printf " ${HE_BORDER}â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NOCOLOR}\n"

    if [ ! -s "$tmp_file" ]; then
        printf " ${HE_BORDER}â”‚${NOCOLOR}  ${HE_MUTED}(empty list)${NOCOLOR}\n"
    else
        while IFS= read -r host || [ -n "$host" ]; do
            [ -z "$host" ] && continue
            printf " ${HE_BORDER}â”‚${NOCOLOR}  ${WHITE}%-40s${NOCOLOR} " "$host"
            print_badge "whitelisted" "success"
            printf "\n"
        done < "$tmp_file"
    fi

    printf " ${HE_BORDER}â”‚${NOCOLOR}\n"
    printf " ${HE_BORDER}â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NOCOLOR}\n"
    printf "\n"

    # Check for changes
    if [ -f "$tmp_file" ] && ! diff -q "$tmp_file" "$WHITELIST_FILE" >/dev/null 2>&1; then
        printf " ${HE_WARNING}âš ${NOCOLOR}  ${HE_MUTED}Unsaved changes${NOCOLOR}\n"
        printf " ${HE_ACCENT}â¯${NOCOLOR} ${HE_MUTED}Enter domain to add/remove${NOCOLOR} (${HE_SUCCESS}s${NOCOLOR}=save ${RED}c${NOCOLOR}=cancel)${HE_MUTED}:${NOCOLOR} "
    else
        printf " ${HE_ACCENT}â¯${NOCOLOR} ${HE_MUTED}Enter domain to add/remove${NOCOLOR} (${RED}c${NOCOLOR}=cancel)${HE_MUTED}:${NOCOLOR} "
    fi
    read_input; selection=$REPLY

    case "$selection" in
        s|S)
            mv "$tmp_file" "$WHITELIST_FILE"
            update_engine
            echo
            press_enter
            return
            ;;
        c|C)
            rm -f "$tmp_file"
            return
            ;;
        "")
            do_whitelist
            return
            ;;
        *)
            # Check if already in list (escape special regex chars for grep)
            escaped_sel=$(printf '%s' "$selection" | sed 's/[.[\*^$]/\\&/g')
            if grep -q "^${escaped_sel}$" "$tmp_file" 2>/dev/null; then
                if confirm "Remove ${selection} from whitelist?"; then
                    sed -i "#^${selection}$#d" "$tmp_file"
                    printf " ${RED}âœ—${NOCOLOR} Removed ${WHITE}%s${NOCOLOR}\n" "$selection"
                    sleep 1
                fi
            else
                echo "$selection" >> "$tmp_file"
                sed -i '/^$/d' "$tmp_file"
                printf " ${HE_SUCCESS}âœ“${NOCOLOR} Added ${WHITE}%s${NOCOLOR}\n" "$selection"
                sleep 1
            fi
            do_whitelist
            ;;
    esac
}

# -----------------------------------------------------------------------------
# FEATURE: BLACKLIST MANAGEMENT
# -----------------------------------------------------------------------------

# Modern blacklist management
do_blacklist() {
    clear_screen
    print_header

    if ! is_helium_active; then
        print_helium_status
        press_enter
        return
    fi

    [ ! -f "$BLACKLIST_FILE" ] && touch "$BLACKLIST_FILE"
    tmp_file="${BLACKLIST_FILE}.tmp"
    [ ! -f "$tmp_file" ] && cp "$BLACKLIST_FILE" "$tmp_file"

    print_section "Blacklist Management" "â›”"
    printf " ${HE_BORDER}â”‚${NOCOLOR}\n"
    printf " ${HE_BORDER}â”‚${NOCOLOR}  ${HE_MUTED}Blacklisted domains will ALWAYS be blocked${NOCOLOR}\n"
    printf " ${HE_BORDER}â”‚${NOCOLOR}\n"
    printf " ${HE_BORDER}â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NOCOLOR}\n"
    printf " ${HE_BORDER}â”‚${NOCOLOR}  ${HE_HEADER}%-40s %12s${NOCOLOR}\n" "DOMAIN" "STATUS"
    printf " ${HE_BORDER}â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NOCOLOR}\n"

    if [ ! -s "$tmp_file" ]; then
        printf " ${HE_BORDER}â”‚${NOCOLOR}  ${HE_MUTED}(empty list)${NOCOLOR}\n"
    else
        while IFS= read -r host || [ -n "$host" ]; do
            [ -z "$host" ] && continue
            printf " ${HE_BORDER}â”‚${NOCOLOR}  ${WHITE}%-40s${NOCOLOR} " "$host"
            print_badge "blocked" "error"
            printf "\n"
        done < "$tmp_file"
    fi

    printf " ${HE_BORDER}â”‚${NOCOLOR}\n"
    printf " ${HE_BORDER}â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NOCOLOR}\n"
    printf "\n"

    # Check for changes
    if [ -f "$tmp_file" ] && ! diff -q "$tmp_file" "$BLACKLIST_FILE" >/dev/null 2>&1; then
        printf " ${HE_WARNING}âš ${NOCOLOR}  ${HE_MUTED}Unsaved changes${NOCOLOR}\n"
        printf " ${HE_ACCENT}â¯${NOCOLOR} ${HE_MUTED}Enter domain to add/remove${NOCOLOR} (${HE_SUCCESS}s${NOCOLOR}=save ${RED}c${NOCOLOR}=cancel)${HE_MUTED}:${NOCOLOR} "
    else
        printf " ${HE_ACCENT}â¯${NOCOLOR} ${HE_MUTED}Enter domain to add/remove${NOCOLOR} (${RED}c${NOCOLOR}=cancel)${HE_MUTED}:${NOCOLOR} "
    fi
    read_input; selection=$REPLY

    case "$selection" in
        s|S)
            mv "$tmp_file" "$BLACKLIST_FILE"
            update_engine
            echo
            press_enter
            return
            ;;
        c|C)
            rm -f "$tmp_file"
            return
            ;;
        "")
            do_blacklist
            return
            ;;
        *)
            # Check if already in list (escape special regex chars for grep)
            escaped_sel=$(printf '%s' "$selection" | sed 's/[.[\*^$]/\\&/g')
            if grep -q "^${escaped_sel}$" "$tmp_file" 2>/dev/null; then
                if confirm "Remove ${selection} from blacklist?"; then
                    sed -i "#^${selection}$#d" "$tmp_file"
                    printf " ${HE_SUCCESS}âœ“${NOCOLOR} Removed ${WHITE}%s${NOCOLOR}\n" "$selection"
                    sleep 1
                fi
            else
                echo "$selection" >> "$tmp_file"
                sed -i '/^$/d' "$tmp_file"
                printf " ${RED}â›”${NOCOLOR} Blocked ${WHITE}%s${NOCOLOR}\n" "$selection"
                sleep 1
            fi
            do_blacklist
            ;;
    esac
}

# -----------------------------------------------------------------------------
# FEATURE: DNS CHANGE
# -----------------------------------------------------------------------------

# Modern DNS change menu
do_change_dns() {
    clear_screen
    print_header
    print_helium_status

    print_section "Change DNS Server" "ðŸŒ"
    printf " ${HE_BORDER}â”‚${NOCOLOR}\n"
    printf " ${HE_BORDER}â”‚${NOCOLOR}  ${HE_ACCENT}[1]${NOCOLOR} ðŸ”· ${WHITE}Google${NOCOLOR}            ${HE_MUTED}8.8.8.8${NOCOLOR}\n"
    printf " ${HE_BORDER}â”‚${NOCOLOR}  ${HE_ACCENT}[2]${NOCOLOR} ðŸŸ  ${WHITE}Cloudflare${NOCOLOR}        ${HE_MUTED}1.1.1.1${NOCOLOR}\n"
    printf " ${HE_BORDER}â”‚${NOCOLOR}  ${HE_ACCENT}[3]${NOCOLOR} ðŸŸ  ${WHITE}Cloudflare Family${NOCOLOR}  ${HE_MUTED}1.1.1.3${NOCOLOR}\n"
    printf " ${HE_BORDER}â”‚${NOCOLOR}  ${HE_ACCENT}[4]${NOCOLOR} ðŸŸ¢ ${WHITE}AdGuard DNS${NOCOLOR}       ${HE_MUTED}94.140.14.14${NOCOLOR}\n"
    printf " ${HE_BORDER}â”‚${NOCOLOR}  ${HE_ACCENT}[5]${NOCOLOR} ðŸŸ¢ ${WHITE}AdGuard Family${NOCOLOR}    ${HE_MUTED}94.140.14.15${NOCOLOR}\n"
    printf " ${HE_BORDER}â”‚${NOCOLOR}  ${HE_ACCENT}[6]${NOCOLOR} ðŸ”µ ${WHITE}Quad9${NOCOLOR}             ${HE_MUTED}9.9.9.9${NOCOLOR}\n"
    printf " ${HE_BORDER}â”‚${NOCOLOR}  ${HE_ACCENT}[7]${NOCOLOR} âš™ï¸  ${WHITE}Custom${NOCOLOR}\n"
    printf " ${HE_BORDER}â”‚${NOCOLOR}  ${HE_ACCENT}[8]${NOCOLOR} ðŸšª ${WHITE}Back to menu${NOCOLOR}\n"
    printf " ${HE_BORDER}â”‚${NOCOLOR}\n"
    printf " ${HE_BORDER}â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NOCOLOR}\n"
    printf "\n"
    printf " ${HE_ACCENT}â¯${NOCOLOR} ${HE_MUTED}Enter option${NOCOLOR} ${WHITE}[1-8]${NOCOLOR}${HE_MUTED}:${NOCOLOR} "
    read_input; option=$REPLY

    case "$option" in
        1) new_dns="8.8.8.8"; provider="Google" ;;
        2) new_dns="1.1.1.1"; provider="Cloudflare" ;;
        3) new_dns="1.1.1.3"; provider="Cloudflare Family" ;;
        4) new_dns="94.140.14.14"; provider="AdGuard" ;;
        5) new_dns="94.140.14.15"; provider="AdGuard Family" ;;
        6) new_dns="9.9.9.9"; provider="Quad9" ;;
        7)
            printf " ${HE_ACCENT}â¯${NOCOLOR} ${HE_MUTED}Enter DNS IP address:${NOCOLOR} "
            read_input; new_dns=$REPLY
            [ -z "$new_dns" ] && do_change_dns && return
            # Validate IP format
            if ! is_valid_ipv4 "$new_dns"; then
                printf " ${RED}âœ—${NOCOLOR} Invalid IP address format\n"
                sleep 1
                do_change_dns
                return
            fi
            provider="Custom"
            ;;
        8|"") return ;;
        *) do_change_dns; return ;;
    esac

    printf " ${HE_MUTED}Changing to %s DNS...${NOCOLOR}" "$provider"
    set_dns_server "$new_dns"
    restart_dnsmasq
    sleep 2
    printf "${HE_SUCCESS}done${NOCOLOR}\n"
    printf " ${HE_SUCCESS}âœ“${NOCOLOR} DNS server changed to ${HE_ACCENT}%s${NOCOLOR}\n" "$new_dns"
    echo
    press_enter
    do_change_dns
}

# -----------------------------------------------------------------------------
# FEATURE: IPV6 TOGGLE (OpenWrt only)
# -----------------------------------------------------------------------------

do_toggle_ipv6() {
    clear_screen
    print_header
    echo

    if ! ip a 2>/dev/null | grep -q "inet6"; then
        printf " IPv6 is currently: "
        println_red "disabled"
        echo

        if confirm "Do you want to enable IPv6?"; then
            printf " Enabling IPv6..."
            echo 0 > /proc/sys/net/ipv6/conf/all/disable_ipv6
            sed -i '/disable_ipv6/d' /etc/rc.local 2>/dev/null
            println_green "done"
            update_engine
        fi
    else
        printf " IPv6 is currently: "
        println_green "enabled"
        echo

        if confirm "Do you want to disable IPv6?"; then
            printf " Disabling IPv6..."
            echo 1 > /proc/sys/net/ipv6/conf/all/disable_ipv6
            # Persist on boot
            if [ -f /etc/rc.local ]; then
                sed -i '/disable_ipv6/d' /etc/rc.local
                sed -i '/^exit 0/i echo 1 > /proc/sys/net/ipv6/conf/all/disable_ipv6' /etc/rc.local 2>/dev/null || \
                    echo 'echo 1 > /proc/sys/net/ipv6/conf/all/disable_ipv6' >> /etc/rc.local
            fi
            println_green "done"
            update_engine
        fi
    fi
    echo
    press_enter
}

# -----------------------------------------------------------------------------
# FEATURE: DATABASE CLEANER
# -----------------------------------------------------------------------------

do_clean_database() {
    clear_screen
    print_header
    echo
    print_helium_status
    echo

    if ! is_helium_active; then
        println_yellow " Helium is not active"
        echo
        press_enter
        return
    fi

    if confirm "Do you want to cleanup the database?"; then
        clean_dead_hosts
    fi
    echo
    press_enter
}

# -----------------------------------------------------------------------------
# FEATURE: UPDATE HELIUM
# -----------------------------------------------------------------------------

do_update_helium() {
    clear_screen
    print_header
    echo

    printf " Checking for updates..."

    tmp_script="/tmp/helium.tmp"
    if ! download_file "$REMOTE_SCRIPT" "$tmp_script"; then
        println_red "failed"
        printf " Could not check for updates\n"
        echo
        press_enter
        return
    fi

    latest_version=$(grep "^VERSION_NUMBER=" "$tmp_script" 2>/dev/null | cut -d'"' -f2 | head -1)
    current_version="$VERSION_NUMBER"

    if [ "$current_version" = "$latest_version" ]; then
        println_green "up to date"
        printf " You are running the latest version (v%s)\n" "$current_version"
        rm -f "$tmp_script"
        echo
        press_enter
        return
    fi

    printf "\n New version available: "
    println_green "v${latest_version}"
    printf " Current version: v%s\n" "$current_version"
    echo

    if ! confirm "Do you want to update?"; then
        rm -f "$tmp_script"
        return
    fi

    if confirm "Overwrite existing providers list?"; then
        download_file "$REMOTE_PROVIDERS" "$PROVIDERS_FILE"
    fi

    printf " Updating Helium..."
    mv "$tmp_script" "$INSTALL_PATH"
    chmod 755 "$INSTALL_PATH"
    println_green "done"

    update_engine

    echo
    printf " Type "
    print_green "helium"
    printf " to start the new version\n"
    echo
    exit 0
}

# CLI upgrade script (non-interactive for scripting)
do_upgrade_script() {
    printf " Checking for updates..."

    tmp_script="/tmp/helium.tmp"
    if ! download_file "$REMOTE_SCRIPT" "$tmp_script"; then
        println_red "failed"
        printf " Could not download from repository\n"
        exit 1
    fi

    latest_version=$(grep "^VERSION_NUMBER=" "$tmp_script" 2>/dev/null | cut -d'"' -f2 | head -1)
    current_version="$VERSION_NUMBER"

    if [ "$current_version" = "$latest_version" ]; then
        println_green "up to date"
        printf " Current version: v%s\n" "$current_version"
        rm -f "$tmp_script"
        exit 0
    fi

    println_yellow "update available"
    printf " Current: v%s â†’ New: v%s\n" "$current_version" "$latest_version"

    # Apply update
    printf " Upgrading Helium..."
    mv "$tmp_script" "$INSTALL_PATH"
    chmod 755 "$INSTALL_PATH"
    println_green "done"

    # Update blocklist with new script
    printf " Updating blocklist..."
    if is_helium_active; then
        # Run update with new script
        "$INSTALL_PATH" --update >/dev/null 2>&1
        println_green "done"
    else
        println_yellow "skipped (not active)"
    fi

    echo
    printf " Upgraded to "
    println_green "v${latest_version}"
    printf " Run "
    print_green "helium"
    printf " to start\n"
}

# -----------------------------------------------------------------------------
# MAIN MENU
# -----------------------------------------------------------------------------

# =============================================================================
# MODERN MAIN MENU
# =============================================================================

# Print a menu item with icon (left column)
print_menu_left() {
    num="$1"
    icon="$2"
    label="$3"
    printf " ${HE_BORDER}â”‚${NOCOLOR}  ${HE_ACCENT}[%2s]${NOCOLOR} %s ${WHITE}%-16s${NOCOLOR}" "$num" "$icon" "$label"
}

# Print a menu item with icon (right column with separator)
print_menu_right() {
    num="$1"
    icon="$2"
    label="$3"
    printf " ${HE_BORDER}â”‚${NOCOLOR}  ${HE_ACCENT}[%2s]${NOCOLOR} %s ${WHITE}%s${NOCOLOR}" "$num" "$icon" "$label"
}

main_menu() {
    while true; do
        clear_screen
        print_header
        print_helium_status
        print_machine_info

        print_section "Quick Actions" "âš¡"

        if [ "$OS_TYPE" = "openwrt" ]; then
            # OpenWrt menu (11 options) - Two column layout with separator
            print_menu_left "1" "â–¶ï¸ " "Start Helium"
            print_menu_right "7" "â›”" "Blacklist Host"
            printf "\n"
            print_menu_left "2" "â¹ï¸ " "Stop Helium"
            print_menu_right "8" "ðŸ”„" "Toggle IPv6"
            printf "\n"
            print_menu_left "3" "ðŸ“¥" "Update Database"
            print_menu_right "9" "â¬†ï¸ " "Update Helium"
            printf "\n"
            print_menu_left "4" "âœ…" "Activate Provider"
            print_menu_right "10" "ðŸ—‘ï¸ " "Uninstall"
            printf "\n"
            print_menu_left "5" "âŒ" "Deactivate Provider"
            print_menu_right "11" "ðŸšª" "Exit"
            printf "\n"
            print_menu_left "6" "âœ¨" "Whitelist Host"
            printf "\n"
        else
            # Linux server menu (12 options) - Two column layout with separator
            print_menu_left "1" "â–¶ï¸ " "Start Helium"
            print_menu_right "7" "â›”" "Blacklist Host"
            printf "\n"
            print_menu_left "2" "â¹ï¸ " "Stop Helium"
            print_menu_right "8" "ðŸŒ" "Change DNS"
            printf "\n"
            print_menu_left "3" "ðŸ“¥" "Update Database"
            print_menu_right "9" "ðŸ§¹" "Clean Database"
            printf "\n"
            print_menu_left "4" "âœ…" "Activate Provider"
            print_menu_right "10" "â¬†ï¸ " "Update Helium"
            printf "\n"
            print_menu_left "5" "âŒ" "Deactivate Provider"
            print_menu_right "11" "ðŸ—‘ï¸ " "Uninstall"
            printf "\n"
            print_menu_left "6" "âœ¨" "Whitelist Host"
            print_menu_right "12" "ðŸšª" "Exit"
            printf "\n"
        fi

        printf " ${HE_BORDER}â”‚${NOCOLOR}\n"
        printf " ${HE_BORDER}â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NOCOLOR}\n"
        printf "\n"

        if [ "$OS_TYPE" = "openwrt" ]; then
            printf " ${HE_ACCENT}â¯${NOCOLOR} ${HE_MUTED}Enter option${NOCOLOR} ${WHITE}[1-11]${NOCOLOR}${HE_MUTED}:${NOCOLOR} "
            read_input; menu_option=$REPLY

            case "$menu_option" in
                1) do_start ;;
                2) do_stop ;;
                3) do_update_database ;;
                4) do_activate_provider ;;
                5) do_deactivate_provider ;;
                6) do_whitelist ;;
                7) do_blacklist ;;
                8) do_toggle_ipv6 ;;
                9) do_update_helium ;;
                10)
                    if confirm "Do you want to uninstall Helium?"; then
                        do_uninstall
                        exit 0
                    fi
                    ;;
                11) exit 0 ;;
                *) ;;
            esac
        else
            printf " ${HE_ACCENT}â¯${NOCOLOR} ${HE_MUTED}Enter option${NOCOLOR} ${WHITE}[1-12]${NOCOLOR}${HE_MUTED}:${NOCOLOR} "
            read_input; menu_option=$REPLY

            case "$menu_option" in
                1) do_start ;;
                2) do_stop ;;
                3) do_update_database ;;
                4) do_activate_provider ;;
                5) do_deactivate_provider ;;
                6) do_whitelist ;;
                7) do_blacklist ;;
                8) do_change_dns ;;
                9) do_clean_database ;;
                10) do_update_helium ;;
                11)
                    if confirm "Do you want to uninstall Helium?"; then
                        do_uninstall
                        exit 0
                    fi
                    ;;
                12) exit 0 ;;
                *) ;;
            esac
        fi
    done
}

# -----------------------------------------------------------------------------
# ENTRY POINT
# -----------------------------------------------------------------------------

main() {
    # Must be root
    check_root

    # Detect environment
    detect_environment

    # Check virtualization (Linux only)
    check_virtualization

    # Handle command line arguments (for cron and scripting)
    case "$1" in
        --update|-u)
            # Update blocklist database
            if is_helium_active; then
                update_engine
            else
                println_red " Helium is not active"
                exit 1
            fi
            exit 0
            ;;
        --upgrade|-U)
            # Update script from remote repository
            do_upgrade_script
            exit 0
            ;;
        --status|-s)
            # Show status and exit
            print_helium_status
            exit 0
            ;;
        --version|-v)
            # Show version
            echo "Helium v${VERSION_NUMBER} (${VERSION_SUFFIX})"
            exit 0
            ;;
        --uninstall|--force-uninstall|-X)
            # Force uninstall - no confirmation, restore original state
            do_force_uninstall
            exit 0
            ;;
        --help|-h)
            echo "Helium v${VERSION_NUMBER} - DNS-based Ad Blocker"
            echo "Usage: helium [OPTION]"
            echo ""
            echo "Options:"
            echo "  --update, -u       Update blocklist database"
            echo "  --upgrade, -U      Update Helium script from repository"
            echo "  --status, -s       Show current status"
            echo "  --version, -v      Show version"
            echo "  --uninstall, -X    Force uninstall and restore original state"
            echo "  --help, -h         Show this help"
            echo ""
            echo "Run without arguments for interactive menu."
            exit 0
            ;;
    esac

    # Check if Helium is installed
    if is_dnsmasq_running && is_helium_active; then
        # Already installed, show menu
        main_menu
    elif [ -f "$ADBLOCK_HOSTS" ] || [ -f "$PROVIDERS_FILE" ]; then
        # Partially installed, show menu
        main_menu
    else
        # Not installed, offer installation
        clear_screen
        print_header
        echo

        if confirm "Helium is not installed. Install now?"; then
            do_install
        else
            exit 0
        fi
    fi
}

# Run main
main "$@"
